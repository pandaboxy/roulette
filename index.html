<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mini Game Hub</title>
  <!-- Yandex.RTB -->
  <script>window.yaContextCb=window.yaContextCb||[]</script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>
  <style>
    body {
      background:#0d1117;
      color:#fff;
      font-family:Arial,sans-serif;
      margin:0;
      padding:0;
    }
    header{display:flex;justify-content:center;margin-top:10px;}
    header button{margin:5px;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
    #content{padding:20px;text-align:center;}
    .balance{font-size:18px;margin-bottom:15px;}
    .slot{width:140px;height:140px;border:4px solid #fff;border-radius:12px;margin:0 auto;background:#161b22;display:flex;align-items:center;justify-content:center;}
    .slot img{max-width:120px;max-height:120px;}
    .inventory-item{display:flex;justify-content:space-between;align-items:center;margin:5px 0;}
    .inventory-item img{width:50px;height:50px;}
    .prizes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;justify-items:center;}
    .prizes-grid img{width:60px;height:60px;}
    button.sell{padding:4px 8px;margin-left:5px;}
    #gameCanvas{background:#87ceeb;margin:0 auto;display:block;}

    /* üîπ Loading Screen */
    #loadingScreen {
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:#0d1117;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      color:#fff;
      font-size:20px;
      z-index:9999;
    }
    .spinner {
      border:6px solid #444;
      border-top:6px solid #fff;
      border-radius:50%;
      width:60px;height:60px;
      animation: spin 1s linear infinite;
      margin-bottom:20px;
    }
    @keyframes spin {
      0% { transform:rotate(0deg);}
      100% { transform:rotate(360deg);}
    }
  </style>
</head>
<body>

<!-- üîπ Loading Screen -->
<div id="loadingScreen">
  <div class="spinner"></div>
  Loading assets... <span id="progress">0%</span>
</div>

<header style="display:none" id="header">
  <button onclick="showTab('roulette')">üé∞ Roulette</button>
  <button onclick="showTab('inventory')">üéí Inventory</button>
  <button onclick="showTab('prizes')">üéÅ Prizes</button>
</header>

<div id="content" style="display:none">
  <div class="balance">Balance: <span id="balance">10000</span> ‚≠ê</div>

  <!-- Roulette -->
  <div id="roulette" style="display:none;">
    <div class="slot"><img id="slotImg" src="images/bear.png"></div>
    <div>
      <button onclick="spin(25)">Spin 25‚≠ê</button>
      <button onclick="spin(50)">Spin 50‚≠ê</button>
    </div>
    <div id="lastResult"></div>
  </div>

  <!-- Inventory -->
  <div id="inventory" style="display:none;">
    <div id="inventoryList"></div>
  </div>

  <!-- Prizes -->
  <div id="prizes" style="display:none;">
    <div class="prizes-grid" id="prizesGrid"></div>
  </div>

  <!-- üîπ Yandex Ad container -->
  <div id="yandexAd" style="margin-top:20px;"></div>
</div>

<script>
// -------------------- Data --------------------
const ITEMS = [
  {img:"images/bear.png",name:"Bear",weight:30,cost:15},
  {img:"images/heart_gift.png",name:"Heart",weight:30,cost:15},
  {img:"images/gift.png",name:"Gift",weight:20,cost:25},
  {img:"images/rose.png",name:"Rose",weight:15,cost:25},
  {img:"images/cake.png",name:"Cake",weight:2,cost:50},
  {img:"images/bouquet.png",name:"Flowers",weight:2,cost:50},
  {img:"images/rocket.png",name:"Rocket",weight:1,cost:50},
  {img:"images/champagne.png",name:"Champagne",weight:1,cost:50},
  {img:"images/trophy.png",name:"Cup",weight:0.03,cost:100},
  {img:"images/ring.png",name:"Ring",weight:0.03,cost:100},
  {img:"images/gem.png",name:"Brilliant",weight:0.03,cost:100},
  {img:"images/star.png",name:"+2500 Balance",weight:0.1,cost:0}
];

let state={stars:10000,inventory:{},spinning:false};

// ‚úÖ Load saved state
if(localStorage.getItem('gameState2')){
  state=JSON.parse(localStorage.getItem('gameState2'));
}
updateBalance();

// -------------------- Preload Assets --------------------
function preloadImages(images, callback){
  let loaded=0;
  images.forEach(src=>{
    const img=new Image();
    img.onload=img.onerror=()=>{
      loaded++;
      document.getElementById("progress").innerText=Math.floor((loaded/images.length)*100)+"%";
      if(loaded===images.length) callback();
    };
    img.src=src;
  });
}

// Start preloading
window.addEventListener("load", ()=>{
  const allImages=ITEMS.map(i=>i.img);
  preloadImages(allImages, ()=>{
    // Hide loading, show game
    document.getElementById("loadingScreen").style.display="none";
    document.getElementById("header").style.display="flex";
    document.getElementById("content").style.display="block";
    showTab('roulette');

    // ‚úÖ Render Yandex ads once game is visible
    window.yaContextCb.push(() => {
      Ya.Context.AdvManager.render({
        "blockId": "R-A-17055982-1",
        "type": "floorAd",
        "platform": "touch",
        "renderTo": "yandexAd"
      })
    });

    // ‚úÖ Start auto stars (+1 every second, max 20000)
    setInterval(()=>{
      if(state.stars < 20000){
        state.stars++;
        updateBalance();
      }
    },1000);
  });
});

// -------------------- Tabs --------------------
function showTab(tab){
  ['roulette','inventory','prizes'].forEach(t=>
    document.getElementById(t).style.display=(t===tab?'block':'none')
  );
  if(tab==='inventory') renderInventory();
  if(tab==='prizes') renderPrizes();
}

// -------------------- Balance --------------------
function updateBalance(){
  document.getElementById('balance').innerText=state.stars;
  saveState();
}
function saveState(){
  localStorage.setItem('gameState1',JSON.stringify(state));
}

// -------------------- Roulette --------------------
function weightedRandom(items){
  const total=items.reduce((s,i)=>s+i.weight,0);
  let r=Math.random()*total;
  for(const item of items){ r-=item.weight; if(r<=0) return item;}
  return items[items.length-1];
}

function spin(cost){
  if(state.spinning) return;
  if(state.stars<cost){alert("Not enough stars");return;}
  const pool=cost===25? ITEMS : ITEMS.filter(i=>i.name!=="Bear"&&i.name!=="Heart");
  const prize=weightedRandom(pool);

  state.stars-=cost;
  state.spinning=true;
  updateBalance();

  const slotImg=document.getElementById('slotImg');
  let i=0;
  const anim=setInterval(()=>{
    const rand=pool[Math.floor(Math.random()*pool.length)];
    slotImg.src=rand.img;
    i++;
    if(i>20){
      clearInterval(anim);
      slotImg.src=prize.img;
      addToInventory(prize);
      state.spinning=false;
      document.getElementById('lastResult').innerText="Won: "+prize.name;
    }
  },120);
}

// -------------------- Inventory --------------------
function addToInventory(item){
  if(item.name==="+2500 Balance"){
    state.stars+=2500;
    updateBalance();
    return;
  }
  state.inventory[item.name]=(state.inventory[item.name]||0)+1;
  saveState();
}

function renderInventory(){
  const container=document.getElementById('inventoryList');
  container.innerHTML='';
  for(const [name,count] of Object.entries(state.inventory)){
    const item=ITEMS.find(i=>i.name===name);
    if(!item) continue;
    const div=document.createElement('div'); 
    div.className='inventory-item';
    div.innerHTML=`
      <span>${name} x${count}</span>
      <img src="${item.img}">
      <button class="sell" onclick="sellItem('${name}')">Sell</button>
    `;
    container.appendChild(div);
  }
}

function sellItem(name){
  const item=ITEMS.find(i=>i.name===name);
  if(!item) return;
  state.stars+=item.cost;
  state.inventory[name]-=1;
  if(state.inventory[name]<=0) delete state.inventory[name];
  updateBalance(); renderInventory(); saveState();
}

// -------------------- Prizes --------------------
function renderPrizes(){
  const grid=document.getElementById('prizesGrid');
  grid.innerHTML='';
  ITEMS.forEach(i=>{
    const div=document.createElement('div');
    div.innerHTML=`
      <img src="${i.img}">
      <div>${i.name}</div>
      <div>Chance: ${i.weight}%</div>
      <div>Cost: ${i.cost}‚≠ê</div>
    `;
    grid.appendChild(div);
  });
}
</script>
</body>
</html>

